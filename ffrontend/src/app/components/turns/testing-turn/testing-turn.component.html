<app-navbar [title]="pageTitle"></app-navbar>
<div class="turn-container">
    <div class="turn-content">
      <h2 class="turn-title">Testing Turn</h2>
      
      <form [formGroup]="turnForm" (ngSubmit)="onSubmit()" class="turn-form">
        <!-- Basic Information -->
        <div class="form-section">
          <h3>Basic Information</h3>
          <div class="form-group">
            <label for="title">Task Title</label>
            <input id="title" type="text" formControlName="title">
            <div class="error-message" *ngIf="turnForm.get('title')?.errors?.['required'] && turnForm.get('title')?.touched">
              Title is required
            </div>
          </div>
  
          <div class="form-group">
            <label for="description">Task Description</label>
            <textarea id="description" formControlName="description" rows="4"></textarea>
            <div class="error-message" *ngIf="turnForm.get('description')?.errors?.['required'] && turnForm.get('description')?.touched">
              Description is required
            </div>
          </div>
  
          <div class="form-row">
            <div class="form-group">
              <label for="testingType">Testing Type</label>
              <select id="testingType" formControlName="testingType">
                <option value="">Select Type</option>
                <option *ngFor="let type of testingTypes" [value]="type">
                  {{type}}
                </option>
              </select>
            </div>
  
            <div class="form-group">
              <label for="timeLimit">Time Limit (minutes)</label>
              <input id="timeLimit" type="number" formControlName="timeLimit" min="15">
            </div>
          </div>
  
          <div class="form-group">
            <label for="applicationUrl">Application URL</label>
            <input id="applicationUrl" type="url" formControlName="applicationUrl" placeholder="https://">
          </div>
        </div>
  
        <!-- Test Environment -->
        <div class="form-section" formGroupName="testEnvironment">
          <h3>Test Environment</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Operating System</label>
              <input type="text" formControlName="operatingSystem">
            </div>
  
            <div class="form-group">
              <label>Browser</label>
              <input type="text" formControlName="browser">
            </div>
  
            <div class="form-group">
              <label>Resolution</label>
              <input type="text" formControlName="resolution">
            </div>
          </div>
  
          <div class="form-group">
            <label>Additional Requirements</label>
            <textarea formControlName="additionalRequirements" rows="2"></textarea>
          </div>
        </div>
  
        <!-- Required Tools -->
        <div class="form-section">
          <h3>Required Testing Tools</h3>
          <button type="button" class="add-button" (click)="addTool()">
            Add Tool
          </button>
  
          <div formArrayName="requiredTools">
            <div *ngFor="let tool of requiredTools.controls; let i=index" 
                 [formGroupName]="i" 
                 class="tool-item">
              <div class="tool-header">
                <h4>Tool {{i + 1}}</h4>
                <button type="button" class="remove-button" (click)="removeTool(i)">×</button>
              </div>
  
              <div class="form-row">
                <div class="form-group">
                  <label>Tool Name</label>
                  <select formControlName="name">
                    <option value="">Select Tool</option>
                    <option *ngFor="let tool of testingTools" [value]="tool">
                      {{tool}}
                    </option>
                  </select>
                </div>
  
                <div class="form-group">
                  <label>Version</label>
                  <input type="text" formControlName="version">
                </div>
              </div>
  
              <div class="form-group">
                <label>Purpose</label>
                <textarea formControlName="purpose" rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Test Scenarios -->
        <div class="form-section">
          <h3>Test Scenarios</h3>
          <button type="button" class="add-button" (click)="addTestScenario()">
            Add Scenario
          </button>
  
          <div formArrayName="testScenarios">
            <div *ngFor="let scenario of testScenarios.controls; let i=index" 
                 [formGroupName]="i" 
                 class="scenario-item">
              <div class="scenario-header">
                <h4>Scenario {{i + 1}}</h4>
                <button type="button" class="remove-button" (click)="removeTestScenario(i)">×</button>
              </div>
  
              <div class="form-group">
                <label>Title</label>
                <input type="text" formControlName="title">
              </div>
  
              <div class="form-group">
                <label>Description</label>
                <textarea formControlName="description" rows="3"></textarea>
              </div>
  
              <div class="form-group">
                <label>Preconditions</label>
                <textarea formControlName="preconditions" rows="2"></textarea>
              </div>
  
              <div class="form-group">
                <label>Priority</label>
                <select formControlName="priority">
                  <option *ngFor="let level of priorityLevels" [value]="level.value">
                    {{level.label}}
                  </option>
                </select>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Test Cases -->
        <div class="form-section">
          <h3>Test Cases</h3>
          <button type="button" class="add-button" (click)="addTestCase()">
            Add Test Case
          </button>
  
          <div formArrayName="testCases">
            <div *ngFor="let testCase of testCases.controls; let i=index" 
                 [formGroupName]="i" 
                 class="test-case-item">
              <div class="test-case-header">
                <h4>Test Case {{i + 1}}</h4>
                <button type="button" class="remove-button" (click)="removeTestCase(i)">×</button>
              </div>
  
              <div class="form-row">
                <div class="form-group">
                  <label>Related Scenario</label>
                  <select formControlName="scenarioId">
                    <option value="">Select Scenario</option>
                    <option *ngFor="let scenario of testScenarios.controls; let j=index" [value]="j">
                      Scenario {{j + 1}}: {{scenario.get('title')?.value}}
                    </option>
                  </select>
                </div>
  
                <div class="form-group">
                  <label>Title</label>
                  <input type="text" formControlName="title">
                </div>
              </div>
  
              <div class="form-group">
                <label>Test Steps</label>
                <button type="button" class="add-step-button" (click)="addTestStep(i)">
                  Add Step
                </button>
                
                <div formArrayName="steps">
                  <div *ngFor="let step of getTestCaseSteps(i).controls; let j=index" 
                       class="step-item">
                    <div class="step-content">
                      <span class="step-number">{{j + 1}}</span>
                      <input [formControlName]="j" placeholder="Enter test step...">
                    </div>
                    <button type="button" class="remove-step-button" 
                            (click)="removeTestStep(i, j)">×</button>
                  </div>
                </div>
           </div>

           <div class="form-group">
             <label>Expected Result</label>
             <textarea formControlName="expectedResult" rows="2"></textarea>
           </div>

           <div class="form-group">
             <label>Test Data</label>
             <textarea formControlName="testData" rows="2"></textarea>
           </div>

           <div class="form-row">
             <div class="form-group checkbox-group">
               <label>
                 <input type="checkbox" formControlName="automatable">
                 Can be Automated
               </label>
             </div>

             <div class="form-group">
               <label>Points</label>
               <input type="number" formControlName="points" min="1" max="100">
             </div>
           </div>
         </div>
       </div>
     </div>

     <!-- Bug Report Template -->
     <div class="form-section" formGroupName="bugReportTemplate">
       <h3>Bug Report Template</h3>
       <div class="form-group">
         <label>Steps to Reproduce Template</label>
         <textarea formControlName="steps" rows="3" 
                   placeholder="Enter step-by-step instructions template..."></textarea>
       </div>

       <div class="form-group">
         <label>Expected Result Template</label>
         <textarea formControlName="expectedResult" rows="2"></textarea>
       </div>

       <div class="form-group">
         <label>Actual Result Template</label>
         <textarea formControlName="actualResult" rows="2"></textarea>
       </div>

       <div class="form-row">
         <div class="form-group">
           <label>Default Severity</label>
           <select formControlName="severity">
             <option value="critical">Critical</option>
             <option value="major">Major</option>
             <option value="minor">Minor</option>
             <option value="trivial">Trivial</option>
           </select>
         </div>

         <div class="form-group">
           <label>Default Priority</label>
           <select formControlName="priority">
             <option *ngFor="let level of priorityLevels" [value]="level.value">
               {{level.label}}
             </option>
           </select>
         </div>
       </div>

       <div class="form-group checkbox-group">
         <label>
           <input type="checkbox" formControlName="attachments">
           Require Screenshots/Attachments
         </label>
       </div>
     </div>

     <!-- Evaluation Criteria -->
     <div class="form-section">
       <h3>Evaluation Criteria</h3>
       <p class="info-text">Total Weight: {{calculateTotalWeight()}}/100</p>
       <button type="button" class="add-button" (click)="addEvaluationCriterion()">
         Add Criterion
       </button>

       <div formArrayName="evaluationCriteria">
         <div *ngFor="let criterion of evaluationCriteria.controls; let i=index" 
              [formGroupName]="i" 
              class="criterion-item">
           <div class="criterion-header">
             <h4>Criterion {{i + 1}}</h4>
             <button type="button" class="remove-button" 
                     (click)="removeEvaluationCriterion(i)">×</button>
           </div>

           <div class="form-group">
             <label>Criterion Title</label>
             <input type="text" formControlName="criterion">
           </div>

           <div class="form-row">
             <div class="form-group">
               <label>Weight (%)</label>
               <input type="number" formControlName="weight" min="0" max="100">
             </div>

             <div class="form-group">
               <label>Description</label>
               <textarea formControlName="description" rows="2"></textarea>
             </div>
           </div>
         </div>
       </div>
     </div>

     <button type="submit" class="submit-button">Save Testing Turn</button>
   </form>
 </div>
</div>